{"version":3,"file":"doType.js","sources":["../../../../../../node_modules/@openenergytools/scl-template-validator/dist/validators/doType.js"],"sourcesContent":["import { getAdjacentClass, iec6185073, iec6185074, iec6185081, validateChildren, } from \"../foundation.js\";\nasync function getSpecificDataObject(lnClass, doName) {\n    if (!lnClass || !doName)\n        return null;\n    const lNodeClasses = getAdjacentClass(await iec6185074, lnClass);\n    return (lNodeClasses\n        .flatMap((lNodeClass) => Array.from(lNodeClass.querySelectorAll(`DataObject`)))\n        .find((dataObject) => dataObject.getAttribute(\"name\") === doName) ?? null);\n}\nasync function getNsdReference(element) {\n    const id = element.getAttribute(\"id\");\n    if (!id)\n        return null;\n    const doOrSdo = element\n        .closest(\"DataTypeTemplates\")\n        ?.querySelector(`LNodeType > DO[type=\"${id}\"], LNodeType > SDO[type=\"${id}\"]`);\n    const doName = doOrSdo?.getAttribute(\"name\");\n    const lNodeType = doOrSdo?.parentElement;\n    const lnClass = lNodeType?.getAttribute(\"lnClass\");\n    return getSpecificDataObject(lnClass, doName);\n}\nfunction getControlServicePresConditions(ctlModel) {\n    if (!ctlModel || ctlModel === \"status-only\")\n        return [];\n    if (ctlModel.includes(\"direct\"))\n        return [\"MOctrl\"];\n    if (ctlModel.includes(\"normal\"))\n        return [\"MOctrl\", \"MOsbo\", \"MOsboNormal\"];\n    if (ctlModel.includes(\"enhanced\"))\n        return [\"MOctrl\", \"MOsbo\", \"MOsboEnhanced\"];\n    return [];\n}\nasync function getMandatoryDataAttribute(doType, cdc) {\n    const nsd73 = await iec6185073;\n    const nsd81 = await iec6185081;\n    const dataAttributes = Array.from(nsd73.querySelectorAll(`CDC[name=\"${cdc}\"] > DataAttribute[presCond=\"M\"]`));\n    const servicePresConds = getControlServicePresConditions(doType.querySelector('DA[name=\"ctlModel\"] > Val')?.textContent?.trim());\n    const serviceDataAttribute = Array.from(nsd81.querySelectorAll(`ServiceCDC[cdc=\"${cdc}\"] > ServiceDataAttribute`)).filter((da) => servicePresConds.includes(da.getAttribute(\"presCond\")));\n    return dataAttributes.concat(serviceDataAttribute);\n}\nasync function validateAttributes(doType, cdc) {\n    const reference = await getNsdReference(doType);\n    if (reference && cdc !== reference.getAttribute(\"type\"))\n        return [\n            {\n                title: `Incorrect common data class. Expected is ${reference}`,\n                message: `${doType.getAttribute(\"id\")}(${cdc})`,\n            },\n        ];\n    return [];\n}\nasync function missingMandatoryChildren(dotype, cdc) {\n    const errors = [];\n    const mandatoryDAs = (await getMandatoryDataAttribute(dotype, cdc)).map((DA) => DA.getAttribute(\"name\"));\n    mandatoryDAs.forEach((mandatoryDa) => {\n        if (!dotype.querySelector(`DA[name=\"${mandatoryDa}\"]`))\n            errors.push({\n                title: `Missing mandatory data attribute ${mandatoryDa}`,\n                message: `${dotype.getAttribute(\"id\")}(${cdc})`,\n            });\n    });\n    return errors;\n}\nexport async function dOTypeValidator(doType) {\n    const errors = [];\n    if (doType.tagName !== \"DOType\")\n        return [];\n    const cdc = doType.getAttribute(\"cdc\");\n    if (!cdc)\n        return [\n            {\n                title: `Missing mandatory attribute cdc`,\n                message: `${doType.getAttribute(\"id\")}`,\n            },\n        ];\n    const incorrectAttributes = await validateAttributes(doType, cdc);\n    const missingChildren = await missingMandatoryChildren(doType, cdc);\n    const issuesChildren = await validateChildren(doType);\n    return errors.concat(missingChildren, issuesChildren, incorrectAttributes);\n}\n//# sourceMappingURL=doType.js.map"],"names":[],"mappings":"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"}